name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  ci:
    name: Lint, Format, Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Run format check
        run: npm run format:check

      - name: Build app
        run: npm run build

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Setup SSH key
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${{ secrets.VPS_PORT }}" "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        shell: bash
        run: |
          ssh -p "${{ secrets.VPS_PORT }}" "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" "bash -lc '
            set -e

            export NVM_DIR=\"$HOME/.nvm\"

            if [ ! -s \"$NVM_DIR/nvm.sh\" ]; then
              mkdir -p \"$NVM_DIR\"
              if command -v curl >/dev/null 2>&1; then
                curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
              elif command -v wget >/dev/null 2>&1; then
                wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
              else
                echo \"Neither curl nor wget is available to install nvm\"
                exit 127
              fi
            fi

            [ -s \"$NVM_DIR/nvm.sh\" ] && . \"$NVM_DIR/nvm.sh\"
            nvm install --lts
            nvm use --lts
            nvm alias default "lts/*"
            hash -r

            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi

            command -v node >/dev/null 2>&1 || { echo \"node: command not found\"; exit 127; }
            command -v npm >/dev/null 2>&1 || { echo \"npm: command not found\"; exit 127; }
            command -v pm2 >/dev/null 2>&1 || { echo \"pm2: command not found\"; exit 127; }

            cd \"${{ secrets.VPS_APP_DIR }}\"
            git fetch origin
            git reset --hard origin/main
            npm ci
            npm run build
            pm2 restart myne-dashboard
            pm2 save
          '"

